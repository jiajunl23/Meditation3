<script src="https://cdn.jsdelivr.net/gh/netizenorg/netnet-standard-library/build/nn.min.js"></script>
<script>
/* global nn */

const GIF = "pheo3.gif"

let BACKGROUND_COLOR = "black"

const params = new URLSearchParams(location.search)
const URL_COLOR = params.get("bg")
const v = params.get("v")

if (URL_COLOR) {
  BACKGROUND_COLOR = URL_COLOR
}

function sleep (ms) {
  return new Promise(resolve => setTimeout(resolve, ms))
}

let GIF_ARRAY = []
let ROTATION_DEG = 90
  
async function createGIF (x, y) {
  const gif = await nn.loadImage(GIF)
  GIF_ARRAY.push({obj: nn.create("img")
    .set({
      src: `${GIF}#${Math.random()}`
    })
    .css({
    position: "absolute",
    left: x - gif.width / 2,
    top: y - gif.height / 2,
    imageRendering: "pixelated",
    transform: "rotate(90deg)",
    transformOrigin: "center center",
    transition: "all 1s"
  })
    .addTo("body"), x: x - gif.width / 2, y: y - gif.height / 2, width: gif.width, opacity: 1, original_width: gif.width})
}

function ph_moves () {
  const length = GIF_ARRAY.length
  ROTATION_DEG += nn.random(-0.1, 0.1)
  for (let i = 0; i < length; i++) {
    const new_x = GIF_ARRAY[i].x + nn.random(-1, 1)
    const new_y = GIF_ARRAY[i].y + nn.random(-1, 1)
    const new_width = GIF_ARRAY[i].width + nn.random(-1, 1)
    const new_opacity = Math.min(1, new_width / GIF_ARRAY[i].original_width)
    GIF_ARRAY[i].obj.css({
      left: new_x,
      top: new_y,
      transform: `rotate(${ROTATION_DEG}deg)`,
      width: new_width,
      opacity: new_opacity
    })
    GIF_ARRAY[i].x = new_x 
    GIF_ARRAY[i].y = new_y
    GIF_ARRAY[i].width = new_width
  }
}

async function create_circle_w_range (num, r, center_x, center_y, start, end) {
  for (let i = 0; i < num; i++) {
    const x = center_x + Math.cos((end - start) * i / num + start) * r
    const y = center_y + Math.sin((end - start) * i / num + start) * r
    await sleep(100)
    createGIF(x, y)
  }
}
  
async function main () {
  nn.get("body").css({backgroundColor: BACKGROUND_COLOR})
  let center_x = nn.width / 2
  let center_y = nn.height * 3 / 4
  create_circle_w_range(7, 200, center_x, center_y, 0, Math.PI / 2)
  center_y = nn.height / 4
  create_circle_w_range(7, 200, center_x, center_y, - Math.PI / 2, 0)
  // center_x = nn.width / 2
  center_y = nn.height / 2
  center_x = nn.width / 3
  create_circle_w_range(10, 300, center_x, center_y, - Math.PI / 3, Math.PI / 3)
  
  // create_circle_w_range(10, 300, center_x, center_y, - Math.PI / 3, Math.PI / 3)
  setInterval(ph_moves, 1000 / 60)
}
  
nn.on("load", main)

</script>